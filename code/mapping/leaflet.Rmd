---
output: html_document
---

```{r setup, include=FALSE}
#install.packages('leaflet')
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(plyr)
library(dplyr)
library(tidyverse)
library(leaflet)
library(leaflet.providers)
library(tidycensus)
library(sf)
library(stringr)
library(htmlwidgets)
library(widgetframe)
options(warn=1)

census_api_key("c1453f57eb58edb56c8e0cbc2abb2fbbef590208")
```

```{r, include=FALSE}
d <- fread("/home/jovyan/project-home/data/ca_with_predictions.csv")
head(d)
```

```{r, include=FALSE}
geoids <- d$GEOID
head(geoids)
```

```{r, include=FALSE}
geo <- get_acs(geography = "tract",
            variables = c("B19013_001"),
            year = 2019,
            state = "06",
            output = "wide",
            geometry = TRUE)
```

```{r, include=FALSE}
cols_to_keep <- c("GEOID", "NAME", "geometry")
geo <- geo[cols_to_keep]
head(geo)
```

```{r, include=FALSE}
geoids_int <- bit64::as.integer64(geo$GEOID)
geo$GEOID <- geoids_int
ca_with_geo <- 
  left_join(
    d,
    geo,
    by = "GEOID")
cols_to_keep_for_map <- c("pred_ev", "GEOID", "NAME", "geometry")
ca_with_geo <- ca_with_geo[, ..cols_to_keep_for_map]
# is.data.frame(ca_with_geo)
without_sf_county <- ca_with_geo[!grepl("San Francisco County", ca_with_geo$NAME),]
head(without_sf_county)
```


```{r, include=FALSE}
as_sf <- st_sf(without_sf_county)
pal <- colorFactor(c("#87dfeb", "yellow", "red"), levels = c("Under 2%", "2%-5%", "Over 5%"), ordered=FALSE)
head(as_sf)
```



```{r warning=FALSE}
lflt <- leaflet(data = as_sf)
lflt <- addProviderTiles(map = lflt, provider = providers$CartoDB.Positron)
lflt <- addPolygons(lflt, popup = ~ str_extract(NAME, "^([^,]*,[^,]*)"),
                stroke = TRUE,
                weight = 0.5,
                opacity = 1,
                color = 'black',
                smoothFactor = 0,
                fillOpacity = 0.7,
                fillColor = ~ pal(pred_ev))
lflt <- addLegend(lflt, "bottomright", 
              pal = pal, 
              values = ~ pred_ev,
              title = "Eviction Risk",
              opacity = 1)
saveWidget(lflt, "leaflet.html", selfcontained = FALSE)
```


