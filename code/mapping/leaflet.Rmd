---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r setup, include=FALSE}
# install.packages('leaflet')
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(plyr)
library(dplyr)
library(stargazer)
library(tidyverse)
library(sandwich)
library(MASS)
library(leaflet)
library(tidycensus)
library(tidyverse)
library(sf)
library(stringr)

census_api_key("c1453f57eb58edb56c8e0cbc2abb2fbbef590208")
```

```{r}
d <- fread("/home/jovyan/project-home/data/ca_with_predictions")
head(d)
```

```{r}
geoids <- d$GEOID
head(geoids)
```

```{r}
geo <- get_acs(geography = "tract",
            variables = c("B19013_001"),
            year = 2019,
            state = "06",
            output = "wide",
            geometry = TRUE)
```

```{r}
cols_to_keep <- c("GEOID", "NAME", "geometry")
geo <- geo[cols_to_keep]
head(geo)
```

```{r}
geoids_int <- bit64::as.integer64(geo$GEOID)
geo$GEOID <- geoids_int
ca_with_geo <- 
  left_join(
    d,
    geo,
    by = "GEOID")
cols_to_keep_for_map <- c("pred_ev", "GEOID", "NAME", "geometry")
ca_with_geo <- ca_with_geo[, ..cols_to_keep_for_map]
# is.data.frame(ca_with_geo)
head(ca_with_geo)
```

```{r}
pal <- colorFactor(topo.colors(2), ca_with_geo$pred_ev)
```


```{r}
ca_with_geo %>%
    # st_transform(crs = "+init=epsg:4326") %>%
    leaflet(width = "100%") %>%
    addProviderTiles(provider = "CartoDB.Positron") %>%
    addPolygons(popup = ~ str_extract(NAME, "^([^,]*)"),
                stroke = FALSE,
                smoothFactor = 0,
                fillOpacity = 0.7,
                color = ~ pal(pred_ev))
```


```{r}
m <- leaflet() %>%
  addTiles() %>%  # Add default OpenStreetMap map tiles
  addMarkers(lng=174.768, lat=-36.852, popup="The birthplace of R")
m  # Print the map
```


